house of force 
---------------

House of Force 공격은 Top Chunk의 특성을 이용한 공격 기법이다. 
```
ubuntu 16.04
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
```

탑청크는 힙 영역의 가장 꼭대기에 있는 청크로써, 
어떤 bin에도 속하지 않으며 bin에 할당 해제된 청크가 없는 경우에 탑청크의 일부분을 떼어내 새로운 청크 영역을 만들어 주는 역할을 한다.

이때 사용자가 할당을 요청한 크기가 탑청크보다 작은 경우에만 탑청크가 분리되어 새로운 청크가 되고, 
사용자가 요청한 크기가 탑청크보다 큰 경우에는 sysmalloc을 통해 추가적으로 영역을 매핑하여 할당한다. 

이때 새로운 탑청크의 시작 주소값은 ```기존 탑청크 주소 + 할당 요청 크기```가 되는데, 
이는 malloc 함수 내부적으로 실행하는 chunk_at_ofset 매크로 때문. 

그 이유를 좀 도식화 해보면, 
```
0                   10 크기 청크 할당요청
    ---------       -------------
                    new chunk 
10  TOP CHUNK ->    -------------
                    TOP CHUNK 
    ---------       --------------
100
```
위 그림처럼 되기 때문. 시작주소가 0이었던 탑청크는 10 크기의 청크 할당 요청을 받는 경우, 
0부터 9까지의 메모리 영역을 새로운 청크에 넘겨주고, 자신은 10부터 100까지의 영역을 사용하게 된다. 
따라서, 탑청크의 시작주소값은 기존 탑청크 주소인 0 + 할당요청크기 10 = 10 이 되는 것. 

house of force 공격은 탑청크의 이러한 특성을 이용한다. 
새로운 청크를 할당할 때 크기가 (임의의 주소 - 탑청크 주소 )인 청크를 할당한다면? 

```새 탑청크 주소 = 기존 탑청크 주소 + 할당요청크기 ``` 공식이기 떄문에, 
```새 탑청크 주소 = 기존 탑청크 주소 +  (임의의 주소 - 탑청크 주소 ) ``` 가 되어 결국은
```새 탑청크 주소 = 임의의 주소 ``` 가 되는것. 

조금 더 구체적으로 하자면, 탑 청크의 크기를 ```2^64-1(64bit) = 0xffffffffffffffff```, ```2^32-1(32bit) = 0xffffffff``` 바이트로 조작한 다음 
```(임의의 주소 - 탑청크 주소 ) - 0x10 ``` 크기의 청크를 할당하면 탑청크의 시작 주소를 원하는대로 변조할 수 있다. 
이때 청크의 크기는 할당을 원하는 주소의 하위바이트에 맞춰 유동적으로 바꿔줘야 한다. 
이는 청크를 최대사이즈로 조정하여 sysmalloc 에 의해 새로운 영역이 매핑되는것을 방지하기 위함. 

0x10을 빼주는 이유는, 청크의  청크 주소 변경 이후 새롭게 할당될 청크는 
탑청크주소 + 0x10 위치에 데이터를 쓰기 때문. 원하는 주소 위치에 써주려면 그것을 고려해야 한다. 

탑청크의 크기가 변조 된 다음 새로 할당하는 힙은 탑청크의 시작주소 위치에 할당되므로, 
한번 더 힙 청크를 할당하면 원하는 임의 주소에 값을 쓰는것이 가능해진다. 

즉, 필요한 조건은 아래와 같다. 
1. 탑청크의 크기 변경 가능
2. 탑청크의 주소값 알아야함 
3. 원하는 크기의 청크 할당 가능
4. 청크 할당 2회 이상 가능

이제 바이너리를 분석해보자. 
create, write 기능이 있고, create를 하면 원하는 크기만큼 동적할당을 진행하고 전역변수 배열에 이를 저장한다. 
write를 하면 몇번째 배열을 사용할지를 정하고, 해당 배열에서 몇번째 위치(아마 8바이트 단위)에 값을 입력할지를 정할 수 있다. 

정석대로 하자. 청크를 하나 할당한 다음, 
해당 청크에서 데이터 영역의 몇번째 위치에 입력을 받아야 탑청크의 주소가 덮이는지를 확인한 후, 
해당 위치를 0xffffffff로 덮어씌운다. 

그 다음 새로 할당할 청크는 특정 함수의 GOT 위치로 들어가야 하므로, 
0xffffffff - got주소 연산을 진행하여 새로 할당할 청크의 크기로 지정해준다. 

이후 새로 청크 할당을 한번 더 하면서 쉘 함수의 주소를 쓰면 쉘이 떨어진다.





